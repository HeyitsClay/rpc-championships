<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPC</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            background: #000; 
            color: #fff; 
            font-family: system-ui, sans-serif;
            height: 100dvh; /* Use dynamic viewport height for mobile */
            overflow: hidden;
        }
        .screen { 
            display: none; 
            height: 100%; 
            padding: 20px;
            flex-direction: column;
        }
        .screen.active { display: flex; }
        h1 { text-align: center; margin-bottom: 20px; }
        button {
            background: #333;
            color: #fff;
            border: 1px solid #666;
            padding: 15px;
            font-size: 16px;
            margin: 5px 0;
            width: 100%;
        }
        .row { display: flex; gap: 10px; justify-content: center; margin: 10px 0; }
        .score { display: flex; justify-content: space-between; padding: 15px; border: 1px solid #444; margin: 10px 0; }
        .moves { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .move { font-size: 48px; padding: 20px; background: #222; border: 1px solid #555; }
        .move.sel { border-color: #fff; background: #444; }
        .dots { display: flex; gap: 5px; justify-content: center; margin: 10px 0; }
        .dot { width: 32px; height: 32px; border: 1px solid #666; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .dot.cur { border-color: #fff; }
        .dot.fil { background: #333; }
        .colors { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
        .color { width: 36px; height: 36px; border: 2px solid #666; }
        .color.sel { border-color: #fff; }
        .big { font-size: 64px; text-align: center; margin: 20px 0; }
        .center { text-align: center; margin: 10px 0; }
        
        /* Unified scoreboard - used on all screens */
        .scoreboard { display:flex; gap:10px; padding:10px; flex-shrink:0; }
        .scorebox { flex:1; padding:10px; display:flex; justify-content:center; align-items:center; }
        .scorenum { background:#000; color:#fff; padding:8px 16px; font-size:20px; font-weight:bold; min-width:50px; text-align:center; }
        
        /* Unified top bar - used on all game screens */
        .top-bar { 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            padding:10px; 
            border-bottom:2px solid #333; 
            position:relative;
            flex-shrink:0;
            min-height:60px;
        }
        .top-bar-team { 
            display:flex; 
            flex-direction:column; 
            align-items:center; 
            min-width:70px;
        }
        .top-bar-name { 
            font-weight:bold; 
            font-size:14px;
        }
        .top-bar-score { 
            font-size:20px; 
            font-weight:bold;
        }
        .top-bar-center {
            display:flex;
            gap:5px;
            flex:1;
            justify-content:center;
            max-width:200px;
        }
        .top-bar-dot {
            background:#000; 
            border:1px solid #555; 
            width:10px; 
            height:10px; 
            border-radius:50%;
        }
        
        /* Fist drop animation - 0.25s down, 0.75s up, synchronized */
        @keyframes fist-drop {
            0% { transform: translateY(0); }
            25% { transform: translateY(20px); }
            100% { transform: translateY(0); }
        }
        .fist-animate { animation: fist-drop 1s ease-out; }
        
        /* Screen transitions */
        .screen { 
            display: none; 
            height: 100%; 
            padding: 20px;
            flex-direction: column;
            opacity: 0;
            transform: translateX(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .screen.active { 
            display: flex; 
            opacity: 1;
            transform: translateX(0);
        }
        
        /* Battle bonk animations */
        @keyframes bonk-rise-left {
            0% { transform: translateX(0) translateY(0) scale(1); }
            40% { transform: translateX(15vw) translateY(-30px) scale(1.1); }
            60% { transform: translateX(20vw) translateY(-20px) scale(1.2); }
            100% { transform: translateX(0) translateY(0) scale(1.3); }
        }
        @keyframes bonk-rise-right {
            0% { transform: translateX(0) translateY(0) scale(1); }
            40% { transform: translateX(-15vw) translateY(-30px) scale(1.1); }
            60% { transform: translateX(-20vw) translateY(-20px) scale(1.2); }
            100% { transform: translateX(0) translateY(0) scale(1.3); }
        }
        @keyframes fade-out {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8) rotate(10deg); }
            100% { opacity: 0; transform: scale(0.5) rotate(-10deg); }
        }
        @keyframes tie-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px) rotate(-5deg); }
            75% { transform: translateX(10px) rotate(5deg); }
        }
        .bonk-winner-left { animation: bonk-rise-left 1s ease-out forwards; }
        .bonk-winner-right { animation: bonk-rise-right 1s ease-out forwards; }
        .bonk-loser { animation: fade-out 0.5s ease-out 0.5s forwards; }
        .tie-shake { animation: tie-shake 0.5s ease-in-out; }
        
        /* Confetti canvas */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }
    </style>
</head>
<body>

<!-- SETUP -->
<div id="s1" class="screen active" style="overflow-y: auto; justify-content: flex-start;">
    <h1 style="margin: 10px 0; font-size: 20px;">RPC Championships</h1>
    <p class="center" style="margin: 5px 0;">First to <b id="target">3</b> wins</p>
    <div class="row" style="margin: 5px 0;">
        <button onclick="chg(-1)" style="width: 50px;">-</button>
        <button onclick="chg(1)" style="width: 50px;">+</button>
    </div>
    <p class="center" style="margin: 5px 0;">Player 1</p>
    <div class="colors" id="c1" style="margin: 5px 0;"></div>
    <p class="center" style="margin: 5px 0;">Player 2</p>
    <div class="colors" id="c2" style="margin: 5px 0;"></div>
    <button onclick="start()" style="margin-top: 15px;">START GAME</button>
</div>

<!-- P1 PICK -->
<div id="s2" class="screen" style="padding:0;">
    <!-- Unified top bar -->
    <div class="top-bar">
        <div class="top-bar-team">
            <span id="n1" class="top-bar-name" style="color:#ff2a6d;">RED</span>
            <span id="s2p1" class="top-bar-score" style="color:#ff2a6d;">0</span>
        </div>
        <div class="top-bar-center">
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
        </div>
        <div class="top-bar-team">
            <span id="n2" class="top-bar-name" style="color:#05d9e8;">BLUE</span>
            <span id="s2p2" class="top-bar-score" style="color:#05d9e8;">0</span>
        </div>
    </div>
    
    <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <h1 id="t2" style="font-size:24px; margin:20px 0;"><span id="t2-color" style="color:#ff2a6d;">RED</span>'s Selection</h1>
        <button onclick="goPick(1)" style="max-width:300px;">PICK MOVES</button>
    </div>
    
    <!-- Match score at bottom -->
    <div class="scoreboard">
        <div class="scorebox" id="sb-p1-box" style="background:#ff2a6d;">
            <div class="scorenum" id="sb-p1">0</div>
        </div>
        <div class="scorebox" id="sb-p2-box" style="background:#05d9e8;">
            <div class="scorenum" id="sb-p2">0</div>
        </div>
    </div>
</div>

<!-- P1 SELECT -->
<div id="s3" class="screen" style="padding:0;">
    <!-- Unified top bar -->
    <div class="top-bar">
        <div class="top-bar-team">
            <span id="n3a" class="top-bar-name" style="color:#ff2a6d;">RED</span>
            <span id="s3a" class="top-bar-score" style="color:#ff2a6d;">0</span>
        </div>
        <div class="top-bar-center">
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
        </div>
        <div class="top-bar-team">
            <span id="n3b" class="top-bar-name" style="color:#05d9e8;">BLUE</span>
            <span id="s3b" class="top-bar-score" style="color:#05d9e8;">0</span>
        </div>
    </div>
    
    <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; overflow-y:auto;">
        <p class="center" style="margin:10px 0;">Round <span id="r3">1</span>/7</p>
        <div class="dots" id="d3" style="gap:8px; justify-content:center; flex-wrap:wrap;"></div>
        <div class="moves" style="margin:20px 0; width:100%; max-width:400px;">
            <button class="move" onclick="pick('rock')">ü™®</button>
            <button class="move" onclick="pick('paper')">üìÑ</button>
            <button class="move" onclick="pick('scissors')">‚úÇÔ∏è</button>
        </div>
    </div>
    
    <!-- Match score at bottom -->
    <div class="scoreboard">
        <div class="scorebox" id="sb-p1-box-s3" style="background:#ff2a6d;">
            <div class="scorenum" id="sb-p1-s3">0</div>
        </div>
        <div class="scorebox" id="sb-p2-box-s3" style="background:#05d9e8;">
            <div class="scorenum" id="sb-p2-s3">0</div>
        </div>
    </div>
</div>

<!-- P2 PICK -->
<div id="s4" class="screen" style="padding:0;">
    <!-- Unified top bar -->
    <div class="top-bar">
        <div class="top-bar-team">
            <span id="n4a" class="top-bar-name" style="color:#ff2a6d;">RED</span>
            <span id="s4p1" class="top-bar-score" style="color:#ff2a6d;">0</span>
        </div>
        <div class="top-bar-center">
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
        </div>
        <div class="top-bar-team">
            <span id="n4b" class="top-bar-name" style="color:#05d9e8;">BLUE</span>
            <span id="s4p2" class="top-bar-score" style="color:#05d9e8;">0</span>
        </div>
    </div>
    
    <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <h1 id="t4" style="font-size:24px; margin:20px 0;"><span id="t4-color" style="color:#05d9e8;">BLUE</span>'s Selection</h1>
        <button onclick="goPick(2)" style="max-width:300px;">PICK MOVES</button>
    </div>
    
    <!-- Match score at bottom -->
    <div class="scoreboard">
        <div class="scorebox" id="sb-p1-box-s4" style="background:#ff2a6d;">
            <div class="scorenum" id="sb-p1-s4">0</div>
        </div>
        <div class="scorebox" id="sb-p2-box-s4" style="background:#05d9e8;">
            <div class="scorenum" id="sb-p2-s4">0</div>
        </div>
    </div>
</div>

<!-- P2 SELECT -->
<div id="s5" class="screen" style="padding:0;">
    <!-- Unified top bar -->
    <div class="top-bar">
        <div class="top-bar-team">
            <span id="n5a" class="top-bar-name" style="color:#ff2a6d;">RED</span>
            <span id="s5a" class="top-bar-score" style="color:#ff2a6d;">0</span>
        </div>
        <div class="top-bar-center">
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
        </div>
        <div class="top-bar-team">
            <span id="n5b" class="top-bar-name" style="color:#05d9e8;">BLUE</span>
            <span id="s5b" class="top-bar-score" style="color:#05d9e8;">0</span>
        </div>
    </div>
    
    <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; overflow-y:auto;">
        <p class="center" style="margin:10px 0;">Round <span id="r5">1</span>/7</p>
        <div class="dots" id="d5" style="gap:8px; justify-content:center; flex-wrap:wrap;"></div>
        <div class="moves" style="margin:20px 0; width:100%; max-width:400px;">
            <button class="move" onclick="pick('rock')">ü™®</button>
            <button class="move" onclick="pick('paper')">üìÑ</button>
            <button class="move" onclick="pick('scissors')">‚úÇÔ∏è</button>
        </div>
    </div>
    
    <!-- Match score at bottom -->
    <div class="scoreboard">
        <div class="scorebox" id="sb-p1-box-s5" style="background:#ff2a6d;">
            <div class="scorenum" id="sb-p1-s5">0</div>
        </div>
        <div class="scorebox" id="sb-p2-box-s5" style="background:#05d9e8;">
            <div class="scorenum" id="sb-p2-s5">0</div>
        </div>
    </div>
</div>

<!-- READY -->
<div id="s6" class="screen" style="padding:0;">
    <!-- Unified top bar -->
    <div class="top-bar">
        <div class="top-bar-team">
            <span id="n6a" class="top-bar-name" style="color:#ff2a6d;">RED</span>
            <span id="s6a" class="top-bar-score" style="color:#ff2a6d;">0</span>
        </div>
        <div class="top-bar-center">
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
            <div class="top-bar-dot"></div>
        </div>
        <div class="top-bar-team">
            <span id="n6b" class="top-bar-name" style="color:#05d9e8;">BLUE</span>
            <span id="s6b" class="top-bar-score" style="color:#05d9e8;">0</span>
        </div>
    </div>
    
    <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <h1 style="font-size:28px; margin:20px 0;">Ready!</h1>
        <button onclick="battle()" style="max-width:300px;">BATTLE</button>
    </div>
    
    <!-- Match score at bottom -->
    <div class="scoreboard">
        <div class="scorebox" id="sb-p1-box-s6" style="background:#ff2a6d;">
            <div class="scorenum" id="sb-p1-s6">0</div>
        </div>
        <div class="scorebox" id="sb-p2-box-s6" style="background:#05d9e8;">
            <div class="scorenum" id="sb-p2-s6">0</div>
        </div>
    </div>
</div>

<!-- BATTLE -->
<div id="s7" class="screen" style="padding:0;">
    <!-- Unified top bar -->
    <div class="top-bar">
        <div class="top-bar-team">
            <span id="n7a" class="top-bar-name">RED</span>
            <span id="seta" class="top-bar-score">0</span>
        </div>
        <div class="top-bar-center" id="pips">
            <!-- Pips will be inserted here -->
        </div>
        <div class="top-bar-team">
            <span id="n7b" class="top-bar-name">BLUE</span>
            <span id="setb" class="top-bar-score">0</span>
        </div>
    </div>
    
    <!-- Top row: Phase display with matching emojis -->
    <div id="phase-row" style="display:flex; align-items:center; justify-content:center; gap:30px; margin:20px 0; min-height:80px;">
        <span id="phase-left" style="font-size:48px;">ü™®</span>
        <span id="cnt" style="font-size:24px; font-weight:bold; min-width:120px; text-align:center;">ROCK</span>
        <span id="phase-right" style="font-size:48px;">ü™®</span>
    </div>
    
    <!-- Bottom row: Cycling fighters - aligned with score boxes -->
    <div style="display:flex; gap:10px; margin:10px 0; align-items:center; flex:1;">
        <div style="flex:1; display:flex; justify-content:center; align-items:center; height:100%;">
            <span id="f1" style="font-size:20vw; line-height:1;">‚ùî</span>
        </div>
        <div style="width:120px;"></div> <!-- Spacer for center text -->
        <div style="flex:1; display:flex; justify-content:center; align-items:center; height:100%;">
            <span id="f2" style="font-size:20vw; line-height:1;">‚ùî</span>
        </div>
    </div>
    
    <!-- Match score at bottom -->
    <div class="scoreboard">
        <div class="scorebox" id="sb-p1-box-s7">
            <div class="scorenum" id="sb-p1-s7">0</div>
        </div>
        <div class="scorebox" id="sb-p2-box-s7">
            <div class="scorenum" id="sb-p2-s7">0</div>
        </div>
    </div>
</div>

<!-- SET END -->
<div id="s8" class="screen" style="padding:0;">
    <!-- Unified top bar -->
    <div class="top-bar">
        <div class="top-bar-team">
            <span id="n8a" class="top-bar-name" style="color:#ff2a6d;">RED</span>
            <span id="set8a" class="top-bar-score" style="color:#ff2a6d;">0</span>
        </div>
        <div class="top-bar-center" id="pips8">
            <!-- Pips will be inserted here -->
        </div>
        <div class="top-bar-team">
            <span id="n8b" class="top-bar-name" style="color:#05d9e8;">BLUE</span>
            <span id="set8b" class="top-bar-score" style="color:#05d9e8;">0</span>
        </div>
    </div>
    
    <!-- Winner announcement -->
    <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:20px;">
        <h1 id="win8" style="font-size:32px; margin:20px 0; text-align:center;">Winner</h1>
        <button onclick="nextSet()" style="max-width:300px;">CONTINUE</button>
    </div>
    
    <!-- Match score at bottom -->
    <div class="scoreboard">
        <div class="scorebox" id="sb-p1-box-s8">
            <div class="scorenum" id="sb-p1-s8">0</div>
        </div>
        <div class="scorebox" id="sb-p2-box-s8">
            <div class="scorenum" id="sb-p2-s8">0</div>
        </div>
    </div>
</div>

<!-- GAME END -->
<div id="s9" class="screen">
    <h1>CHAMPION</h1>
    <h1 id="win9">Winner</h1>
    <div class="score">
        <span id="n9a" style="font-weight:bold; color:#ff2a6d;">RED</span>
        <span id="s9a">0</span>
        <span>-</span>
        <span id="s9b">0</span>
        <span id="n9b" style="font-weight:bold; color:#05d9e8;">BLUE</span>
    </div>
    <button onclick="again()">PLAY AGAIN</button>
    <button onclick="menu()">MENU</button>
</div>

<canvas id="confetti-canvas"></canvas>

<script>
// State
let target = 3;
let p1c = '#ff2a6d', p2c = '#05d9e8';
let p1n = 'RED', p2n = 'BLUE';
let p1s = 0, p2s = 0;
let p1set = 0, p2set = 0;
let p1moves = [], p2moves = [];
let curRound = 0, curPlayer = 1;
let results = [];

const COLS = [
    ['#ff2a6d','RED'],['#05d9e8','BLUE'],['#aaff00','GREEN'],
    ['#ffaa00','ORANGE'],['#aa00ff','PURPLE'],['#ff69b4','PINK']
];
const MOVES = {rock:'ü™®',paper:'üìÑ',scissors:'‚úÇÔ∏è'};
const CYCLE = ['‚ùî','ü™®','‚ùî','‚úÇÔ∏è','‚ùî','üìÑ'];

// Haptic feedback helper
function haptic(pattern = 10) {
    if (navigator.vibrate) navigator.vibrate(pattern);
}

// Wake lock helper
let wakeLock = null;
async function requestWakeLock() {
    if ('wakeLock' in navigator) {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
        } catch (e) {
            console.log('Wake lock failed:', e);
        }
    }
}

// Confetti effect - big=true for match win, false for set win
function startConfetti(winnerColor, big = true) {
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    const particles = [];
    const colors = [winnerColor, '#fff', '#ffd700', '#ff6b6b', '#4ecdc4'];
    const count = big ? 150 : 40; // Fewer particles for set win
    
    for (let i = 0; i < count; i++) {
        particles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height - canvas.height,
            vx: (Math.random() - 0.5) * 4,
            vy: Math.random() * 3 + 2,
            color: colors[Math.floor(Math.random() * colors.length)],
            size: Math.random() * (big ? 8 : 6) + (big ? 4 : 3),
            rotation: Math.random() * Math.PI * 2,
            rotationSpeed: (Math.random() - 0.5) * 0.2
        });
    }
    
    let animationId;
    let startTime = Date.now();
    const duration = big ? 5000 : 2000; // 5s for match, 2s for set
    
    function animate() {
        const elapsed = Date.now() - startTime;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        particles.forEach(p => {
            p.x += p.vx;
            p.y += p.vy;
            p.rotation += p.rotationSpeed;
            p.vy += 0.05; // gravity
            
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rotation);
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
            ctx.restore();
            
            if (p.y > canvas.height) {
                p.y = -10;
                p.vy = Math.random() * 3 + 2;
            }
        });
        
        if (elapsed < duration) {
            animationId = requestAnimationFrame(animate);
        } else {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    }
    
    animate();
    
    // Cleanup on resize
    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }, { once: true });
}

// Explosion confetti at specific position (for battle bonk)
function explosionConfetti(x, y, color) {
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    const particles = [];
    const colors = [color, '#fff', '#ffd700', '#ff6b6b'];
    
    for (let i = 0; i < 60; i++) {
        const angle = (Math.PI * 2 * i) / 60 + Math.random() * 0.5;
        const speed = Math.random() * 8 + 4;
        particles.push({
            x: x,
            y: y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            color: colors[Math.floor(Math.random() * colors.length)],
            size: Math.random() * 6 + 3,
            rotation: Math.random() * Math.PI * 2,
            rotationSpeed: (Math.random() - 0.5) * 0.3,
            life: 1.0
        });
    }
    
    let startTime = Date.now();
    
    function animate() {
        const elapsed = Date.now() - startTime;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        let alive = false;
        particles.forEach(p => {
            if (p.life <= 0) return;
            alive = true;
            
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.3; // gravity
            p.vx *= 0.95; // friction
            p.rotation += p.rotationSpeed;
            p.life -= 0.02;
            
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rotation);
            ctx.globalAlpha = p.life;
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
            ctx.restore();
        });
        
        if (alive && elapsed < 2000) {
            requestAnimationFrame(animate);
        } else {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    }
    
    animate();
}

// Init
function show(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

// Update all scoreboards across all screens to keep them in sync
function updateAllScoreboards() {
    haptic(5); // Light haptic on score update
    // Update all P1 score boxes
    document.querySelectorAll('[id^="sb-p1-box"]').forEach(box => box.style.background = p1c);
    document.querySelectorAll('[id^="sb-p1"]').forEach(el => {
        if (el.id.includes('box')) return; // Skip boxes
        el.textContent = p1s;
    });
    // Update all P2 score boxes
    document.querySelectorAll('[id^="sb-p2-box"]').forEach(box => box.style.background = p2c);
    document.querySelectorAll('[id^="sb-p2"]').forEach(el => {
        if (el.id.includes('box')) return; // Skip boxes
        el.textContent = p2s;
    });
}

function init() {
    renderColors();
    show('s1');
}

function renderColors() {
    const c1 = document.getElementById('c1');
    const c2 = document.getElementById('c2');
    c1.innerHTML = '';
    c2.innerHTML = '';
    COLS.forEach(([c,n]) => {
        const b1 = document.createElement('button');
        b1.className = 'color' + (c === p1c ? ' sel' : '');
        b1.style.background = c;
        b1.onclick = () => { p1c = c; p1n = n; renderColors(); };
        c1.appendChild(b1);
        
        const b2 = document.createElement('button');
        b2.className = 'color' + (c === p2c ? ' sel' : '') + (c === p1c ? '' : '');
        b2.style.background = c;
        b2.style.opacity = c === p1c ? '0.3' : '1';
        b2.onclick = () => { if (c !== p1c) { p2c = c; p2n = n; renderColors(); } };
        c2.appendChild(b2);
    });
}

function chg(d) {
    target = Math.max(1, Math.min(5, target + d));
    document.getElementById('target').textContent = target;
    haptic(15);
}

function start() {
    p1s = 0; p2s = 0;
    newSet();
    requestWakeLock(); // Keep screen awake during game
    show('s2');
}

function newSet() {
    p1moves = new Array(7).fill(null);
    p2moves = new Array(7).fill(null);
    p1set = 0; p2set = 0;
    curRound = 0;
    results = [];
    
    // Update P1 pick screen (s2) - top bar names, scores and colors
    document.getElementById('t2-color').textContent = p1n;
    document.getElementById('t2-color').style.color = p1c;
    document.getElementById('n1').textContent = p1n;
    document.getElementById('n1').style.color = p1c;
    document.getElementById('s2p1').textContent = p1s;
    document.getElementById('s2p1').style.color = p1c;
    document.getElementById('n2').textContent = p2n;
    document.getElementById('n2').style.color = p2c;
    document.getElementById('s2p2').textContent = p2s;
    document.getElementById('s2p2').style.color = p2c;
    
    // Update names and colors on P2 pick screen (s4)
    const t4Color = document.getElementById('t4-color');
    if (t4Color) {
        t4Color.textContent = p2n;
        t4Color.style.color = p2c;
    }
    
    // Update ALL scoreboards
    updateAllScoreboards();
}

function goPick(p) {
    curPlayer = p;
    curRound = 0;
    while (curRound < 7 && (p === 1 ? p1moves : p2moves)[curRound]) curRound++;
    if (curRound >= 7) curRound = 0;
    updatePickScreen();
    
    // Set match score boxes, names and dot colors for selection screen
    const playerColor = p === 1 ? p1c : p2c;
    if (p === 1) {
        // Update team names and match scores on P1 select screen top bar
        document.getElementById('n3a').textContent = p1n;
        document.getElementById('n3a').style.color = p1c;
        document.getElementById('s3a').textContent = p1s;
        document.getElementById('s3a').style.color = p1c;
        document.getElementById('n3b').textContent = p2n;
        document.getElementById('n3b').style.color = p2c;
        document.getElementById('s3b').textContent = p2s;
        document.getElementById('s3b').style.color = p2c;
        // Update s3 scoreboard
        document.getElementById('sb-p1-box-s3').style.background = p1c;
        document.getElementById('sb-p2-box-s3').style.background = p2c;
        document.getElementById('sb-p1-s3').textContent = p1s;
        document.getElementById('sb-p2-s3').textContent = p2s;
        // Set dot border color for P1
        setTimeout(() => {
            document.getElementById('d3').querySelectorAll('.dot').forEach(d => {
                d.style.border = '2px solid ' + playerColor;
            });
        }, 0);
        show('s3');
    } else {
        // Update team names and match scores on P2 select screen top bar
        document.getElementById('n5a').textContent = p1n;
        document.getElementById('n5a').style.color = p1c;
        document.getElementById('s5a').textContent = p1s;
        document.getElementById('s5a').style.color = p1c;
        document.getElementById('n5b').textContent = p2n;
        document.getElementById('n5b').style.color = p2c;
        document.getElementById('s5b').textContent = p2s;
        document.getElementById('s5b').style.color = p2c;
        // Update s5 scoreboard
        document.getElementById('sb-p1-box-s5').style.background = p1c;
        document.getElementById('sb-p2-box-s5').style.background = p2c;
        document.getElementById('sb-p1-s5').textContent = p1s;
        document.getElementById('sb-p2-s5').textContent = p2s;
        // Set dot border color for P2
        setTimeout(() => {
            document.getElementById('d5').querySelectorAll('.dot').forEach(d => {
                d.style.border = '2px solid ' + playerColor;
            });
        }, 0);
        show('s5');
    }
}

function updatePickScreen() {
    const isP1 = curPlayer === 1;
    const playerColor = isP1 ? p1c : p2c;
    document.getElementById(isP1 ? 'r3' : 'r5').textContent = curRound + 1;
    const dots = document.getElementById(isP1 ? 'd3' : 'd5');
    const moves = isP1 ? p1moves : p2moves;
    dots.innerHTML = '';
    for (let i = 0; i < 7; i++) {
        const d = document.createElement('div');
        d.className = 'dot' + (i === curRound ? ' cur' : '') + (moves[i] ? ' fil' : '');
        d.style.width = '40px';
        d.style.height = '40px';
        d.style.fontSize = '20px';
        d.style.display = 'flex';
        d.style.alignItems = 'center';
        d.style.justifyContent = 'center';
        d.style.border = '2px solid ' + playerColor;
        d.style.background = moves[i] ? '#222' : '#000';
        d.style.borderRadius = '50%';
        d.style.color = playerColor; // For pulse animation currentColor
        d.textContent = moves[i] ? MOVES[moves[i]] : '';
        dots.appendChild(d);
    }
    // Clear selections
    document.querySelectorAll('.move').forEach(m => m.classList.remove('sel'));
    if (moves[curRound]) {
        const map = {rock:0, paper:1, scissors:2};
        const btns = document.querySelectorAll(isP1 ? '#s3 .move' : '#s5 .move');
        if (btns[map[moves[curRound]]]) btns[map[moves[curRound]]].classList.add('sel');
    }
}

function pick(m) {
    haptic(20); // Haptic on move selection
    if (curPlayer === 1) p1moves[curRound] = m;
    else p2moves[curRound] = m;
    
    if (curRound < 6) {
        curRound++;
        updatePickScreen();
    } else {
        if (curPlayer === 1) {
            // Update P2 pick screen - top bar names and scores
            document.getElementById('n4a').textContent = p1n;
            document.getElementById('n4a').style.color = p1c;
            document.getElementById('s4p1').textContent = p1s;
            document.getElementById('s4p1').style.color = p1c;
            document.getElementById('n4b').textContent = p2n;
            document.getElementById('n4b').style.color = p2c;
            document.getElementById('s4p2').textContent = p2s;
            document.getElementById('s4p2').style.color = p2c;
            // Update s4 scoreboard
            document.getElementById('sb-p1-box-s4').style.background = p1c;
            document.getElementById('sb-p2-box-s4').style.background = p2c;
            document.getElementById('sb-p1-s4').textContent = p1s;
            document.getElementById('sb-p2-s4').textContent = p2s;
            show('s4');
        } else {
            // Update ready screen - top bar names and scores
            document.getElementById('n6a').textContent = p1n;
            document.getElementById('n6a').style.color = p1c;
            document.getElementById('s6a').textContent = p1s;
            document.getElementById('s6a').style.color = p1c;
            document.getElementById('n6b').textContent = p2n;
            document.getElementById('n6b').style.color = p2c;
            document.getElementById('s6b').textContent = p2s;
            document.getElementById('s6b').style.color = p2c;
            // Update s6 scoreboard
            document.getElementById('sb-p1-box-s6').style.background = p1c;
            document.getElementById('sb-p2-box-s6').style.background = p2c;
            document.getElementById('sb-p1-s6').textContent = p1s;
            document.getElementById('sb-p2-s6').textContent = p2s;
            show('s6');
        }
    }
}

function back() {
    if (curRound > 0) {
        curRound--;
        updatePickScreen();
    }
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// Web Audio API sound effects
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSound(type) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    
    const now = audioCtx.currentTime;
    
    switch(type) {
        case 'win1': // P1 win - higher pitch victory
            osc.type = 'square';
            osc.frequency.setValueAtTime(523.25, now); // C5
            osc.frequency.setValueAtTime(659.25, now + 0.1); // E5
            osc.frequency.setValueAtTime(783.99, now + 0.2); // G5
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            osc.start(now);
            osc.stop(now + 0.4);
            break;
        case 'win2': // P2 win - lower pitch victory
            osc.type = 'square';
            osc.frequency.setValueAtTime(392.00, now); // G4
            osc.frequency.setValueAtTime(493.88, now + 0.1); // B4
            osc.frequency.setValueAtTime(587.33, now + 0.2); // D5
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            osc.start(now);
            osc.stop(now + 0.4);
            break;
        case 'tie': // Tie - dissonant/dull sound
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(300, now);
            osc.frequency.linearRampToValueAtTime(280, now + 0.3);
            gain.gain.setValueAtTime(0.08, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(now);
            osc.stop(now + 0.3);
            break;
        case 'count': // Countdown beat
            osc.type = 'sine';
            osc.frequency.setValueAtTime(440, now); // A4
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
            osc.start(now);
            osc.stop(now + 0.15);
            break;
        case 'shoot': // Shoot reveal
            osc.type = 'square';
            osc.frequency.setValueAtTime(220, now);
            osc.frequency.exponentialRampToValueAtTime(880, now + 0.2);
            gain.gain.setValueAtTime(0.15, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(now);
            osc.stop(now + 0.3);
            break;
        case 'click': // Button click - soft beep
            osc.type = 'sine';
            osc.frequency.setValueAtTime(1200, now);
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.08, now + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.08);
            osc.start(now);
            osc.stop(now + 0.08);
            break;
    }
}

async function battle() {
    show('s7');
    document.getElementById('n7a').textContent = p1n;
    document.getElementById('n7a').style.color = p1c;
    document.getElementById('n7b').textContent = p2n;
    document.getElementById('n7b').style.color = p2c;
    document.getElementById('seta').textContent = '0';
    document.getElementById('seta').style.color = p1c;
    document.getElementById('setb').textContent = '0';
    document.getElementById('setb').style.color = p2c;
    
    // Update s7 scoreboard
    document.getElementById('sb-p1-box-s7').style.background = p1c;
    document.getElementById('sb-p2-box-s7').style.background = p2c;
    document.getElementById('sb-p1-s7').textContent = p1s;
    document.getElementById('sb-p2-s7').textContent = p2s;
    
    // Set fighter sizes - use clamp for responsive sizing
    document.getElementById('f1').style.fontSize = 'clamp(60px, 20vw, 150px)';
    document.getElementById('f2').style.fontSize = 'clamp(60px, 20vw, 150px)';
    
    // Initialize empty pips at start (black = not played)
    const pips = document.getElementById('pips');
    pips.innerHTML = '';
    for (let i = 0; i < 7; i++) {
        const p = document.createElement('div');
        p.style.width = '10px';
        p.style.height = '10px';
        p.style.borderRadius = '50%';
        p.style.background = '#000';
        p.style.border = '1px solid #555';
        pips.appendChild(p);
    }
    
    for (let round = 0; round < 7; round++) {
        const phases = ['ROCK','PAPER','SCISSORS','SHOOT!'];
        const phaseEmojis = {ROCK:'ü™®', PAPER:'üìÑ', SCISSORS:'‚úÇÔ∏è', 'SHOOT!':'üéØ'};
        
        // Reset text color at start of round
        document.getElementById('cnt').style.color = '#fff';
        
        // Start with fists
        const f1 = document.getElementById('f1');
        const f2 = document.getElementById('f2');
        f1.textContent = 'ü§ú';
        f2.textContent = 'ü§õ';
        
        for (let i = 0; i < 4; i++) {
            const phase = phases[i];
            document.getElementById('cnt').textContent = phase;
            document.getElementById('phase-left').textContent = phaseEmojis[phase];
            document.getElementById('phase-right').textContent = phaseEmojis[phase];
            
            if (i < 3) {
                // ROCK, PAPER, SCISSORS - synchronized fist drop on 1s beat
                // Remove, force reflow, then add to restart animation
                f1.classList.remove('fist-animate');
                f2.classList.remove('fist-animate');
                void f1.offsetWidth; // force reflow
                void f2.offsetWidth;
                f1.classList.add('fist-animate');
                f2.classList.add('fist-animate');
                playSound('count');
                await sleep(1000); // 1 second per phase
            } else {
                // SHOOT! - reveal actual moves
                f1.textContent = MOVES[p1moves[round]];
                f2.textContent = MOVES[p2moves[round]];
                playSound('shoot');
                await sleep(2000); // reveal for 2s
                
                // Clear phase row but keep fighters
                document.getElementById('cnt').textContent = '';
                document.getElementById('cnt').style.color = '#fff';
                document.getElementById('phase-left').textContent = '';
                document.getElementById('phase-right').textContent = '';
            }
        }
        
        const m1 = p1moves[round], m2 = p2moves[round];
        let winner, txt;
        
        if (m1 === m2) {
            winner = 'tie'; txt = 'DRAW +0.5';
            p1set += 0.5; p2set += 0.5;
        } else if ((m1==='rock'&&m2==='scissors')||(m1==='paper'&&m2==='rock')||(m1==='scissors'&&m2==='paper')) {
            winner = 'p1'; txt = p1n + ' WINS';
            p1set += 1;
        } else {
            winner = 'p2'; txt = p2n + ' WINS';
            p2set += 1;
        }
        
        results.push(winner);
        document.getElementById('seta').textContent = p1set;
        document.getElementById('setb').textContent = p2set;
        
        // Show result in top row with win emoji and winner color
        const cntEl = document.getElementById('cnt');
        cntEl.textContent = txt;
        cntEl.style.color = winner === 'p1' ? p1c : (winner === 'p2' ? p2c : '#fff');
        document.getElementById('phase-left').textContent = 'üèÜ';
        document.getElementById('phase-right').textContent = 'üèÜ';
        
        // Play sound effect and haptic based on result
        if (winner === 'tie') { playSound('tie'); haptic([30, 50, 30]); }
        else if (winner === 'p1') { playSound('win1'); haptic([50, 30, 80]); }
        else { playSound('win2'); haptic([50, 30, 80]); }
        
        // BONK ANIMATION: Winner rises and bonks loser
        if (winner !== 'tie') {
            const winnerEl = winner === 'p1' ? f1 : f2;
            const loserEl = winner === 'p1' ? f2 : f1;
            const winnerColor = winner === 'p1' ? p1c : p2c;
            
            // Remove any existing animation classes
            f1.classList.remove('bonk-winner-left', 'bonk-winner-right', 'bonk-loser');
            f2.classList.remove('bonk-winner-left', 'bonk-winner-right', 'bonk-loser');
            void f1.offsetWidth; // force reflow
            void f2.offsetWidth;
            
            // Add animation classes
            winnerEl.classList.add(winner === 'p1' ? 'bonk-winner-left' : 'bonk-winner-right');
            loserEl.classList.add('bonk-loser');
            
            // Trigger explosion confetti at bonk point (center of screen)
            setTimeout(() => {
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight * 0.6;
                explosionConfetti(centerX, centerY, winnerColor);
            }, 500);
            
            await sleep(1500); // Wait for bonk animation
        } else {
            // Tie animation - both shake
            f1.classList.add('tie-shake');
            f2.classList.add('tie-shake');
            await sleep(1000);
            f1.classList.remove('tie-shake');
            f2.classList.remove('tie-shake');
        }
        
        // Reset fighters for next round
        f1.classList.remove('bonk-winner-left', 'bonk-winner-right', 'bonk-loser');
        f1.style.transform = '';
        f1.style.opacity = '1';
        f2.classList.remove('bonk-winner-left', 'bonk-winner-right', 'bonk-loser');
        f2.style.transform = '';
        f2.style.opacity = '1';
        
        // Update pips with colors
        const pips = document.getElementById('pips');
        pips.innerHTML = '';
        for (let i = 0; i < 7; i++) {
            const p = document.createElement('div');
            p.style.width = '10px';
            p.style.height = '10px';
            p.style.borderRadius = '50%';
            p.style.border = '1px solid #555';
            if (results[i] === 'p1') p.style.background = p1c;
            else if (results[i] === 'p2') p.style.background = p2c;
            else if (results[i] === 'tie') p.style.background = '#fff';
            else p.style.background = '#000';
            pips.appendChild(p);
        }
        
        // Update match scores
        document.getElementById('sb-p1-s7').textContent = p1s;
        document.getElementById('sb-p2-s7').textContent = p2s;
        
        await sleep(1500);
        
        // Early exit check
        const remain = 6 - round;
        if (p1set > p2set + remain) break;
        if (p2set > p1set + remain) break;
    }
    
    endSet();
}

function endSet() {
    let win;
    if (p1set > p2set) win = 'p1';
    else if (p2set > p1set) win = 'p2';
    else win = 'tie';
    
    if (win === 'p1') p1s++;
    else if (win === 'p2') p2s++;
    else if (win === 'tie') { p1s += 0.5; p2s += 0.5; }
    
    // Play set end sound
    if (win === 'tie') playSound('tie');
    else if (win === 'p1') playSound('win1');
    else playSound('win2');
    
    // Set end screen with colors
    document.getElementById('n8a').textContent = p1n;
    document.getElementById('n8a').style.color = p1c;
    document.getElementById('set8a').textContent = p1set;
    document.getElementById('set8a').style.color = p1c;
    document.getElementById('n8b').textContent = p2n;
    document.getElementById('n8b').style.color = p2c;
    document.getElementById('set8b').textContent = p2set;
    document.getElementById('set8b').style.color = p2c;
    
    // Winner announcement
    document.getElementById('win8').textContent = win === 'tie' ? 'SET TIED' : (win === 'p1' ? p1n : p2n) + ' WINS SET';
    document.getElementById('win8').style.color = win === 'p1' ? p1c : (win === 'p2' ? p2c : '#fff');
    
    // Small confetti burst for set win (not tie)
    if (win !== 'tie') {
        startConfetti(win === 'p1' ? p1c : p2c, false);
    }
    
    // Render set result pips
    const pips8 = document.getElementById('pips8');
    pips8.innerHTML = '';
    for (let i = 0; i < 7; i++) {
        const p = document.createElement('div');
        p.style.width = '10px';
        p.style.height = '10px';
        p.style.borderRadius = '50%';
        p.style.border = '1px solid #555';
        if (results[i] === 'p1') p.style.background = p1c;
        else if (results[i] === 'p2') p.style.background = p2c;
        else if (results[i] === 'tie') p.style.background = '#fff';
        else p.style.background = '#000';
        pips8.appendChild(p);
    }
    
    // Update s8 scoreboard
    document.getElementById('sb-p1-box-s8').style.background = p1c;
    document.getElementById('sb-p2-box-s8').style.background = p2c;
    document.getElementById('sb-p1-s8').textContent = p1s;
    document.getElementById('sb-p2-s8').textContent = p2s;
    
    if (p1s >= target || p2s >= target) {
        const winnerColor = p1s >= target ? p1c : p2c;
        document.getElementById('win9').textContent = (p1s >= target ? p1n : p2n) + ' WINS!';
        document.getElementById('win9').style.color = winnerColor;
        document.getElementById('n9a').textContent = p1n;
        document.getElementById('n9a').style.color = p1c;
        document.getElementById('n9b').textContent = p2n;
        document.getElementById('n9b').style.color = p2c;
        document.getElementById('s9a').textContent = p1s;
        document.getElementById('s9b').textContent = p2s;
        haptic([100, 50, 100, 50, 200]); // Victory haptic
        startConfetti(winnerColor, true); // Big confetti for match win
        show('s9');
    } else {
        show('s8');
    }
}

function nextSet() {
    newSet();
    show('s2');
}

function again() {
    p1s = 0; p2s = 0;
    newSet();
    show('s2');
}

function menu() {
    // Release wake lock when going back to menu
    if (wakeLock) {
        wakeLock.release().catch(() => {});
        wakeLock = null;
    }
    show('s1');
}

// Add click sound to all buttons
document.addEventListener('click', function(e) {
    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
        playSound('click');
    }
});

// Start
init();
</script>
</body>
</html>
